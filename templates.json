[
  {
    "name": "扩展用户字段",
    "templates": [
      {
        "id": "add-location-to-metadata",
        "title_zh": "将用户最新位置信息写入 Metadata",
        "overview_zh": "将用户最新位置信息写入 Metadata, 使用前请务必判断 context.geo 是否存在 . context.geo 字段详细内容请见：https://docs.authing.cn//authing/extensibility/pipeline/context-object",
        "categories": [
          "扩展用户字段"
        ],
        "types": [
          "POST_AUTHENTICATION"
        ],
        "code": "async function pipe(user, context, callback) {\n  // 请先判断是否成功获取 context.ip\n  if (context.ip) {\n    user.addMetaDataAndPersist('latestIp', JSON.stringify(context.ip))\n    user.addMetaDataAndPersist(\"latestLocation\", JSON.stringify(context.geo))\n  }\n  callback(null, user, context)\n}"
      },
      {
        "id": "change-default-avatar",
        "title_zh": "修改默认头像",
        "overview_zh": "Authing 默认的头像为：https://usercontents.authing.cn/authing-avatar.png . 这里可以修改成你自己想要的默认头像。",
        "categories": [
          "扩展用户字段"
        ],
        "types": [
          "POST_REGISTER"
        ],
        "code": "async function pipe(user, context, callback) {\n  user.photo = \"https://usercontents.authing.cn/avatar.png\"\n  callback(null, user, context)\n}"
      },
      {
        "id": "persist-metadata",
        "title_zh": "添加自定义用户 Metadata",
        "overview_zh": "为用户添加自定义字段 Metadata，并可以持久化保存至数据库。 user.addMetaData(\"KEY\",\"VALUE\") 仅对当前请求有效。 user.addMetaDataAndPersist(\"KEY\", \"VALUE\") 会保存至数据库。",
        "categories": [
          "扩展用户字段"
        ],
        "types": [
          "POST_REGISTER",
          "POST_AUTHENTICATION"
        ],
        "code": "async function pipe(user, context, callback) {\n  user.addMetaData('KEY1', 'VALUE1')\n  user.addMetaDataAndPersist('KEY2', 'VALUE2')\n  callback(null, user, context)\n}"
      }
    ]
  },
  {
    "name": "访问控制",
    "templates": [
      {
        "id": "add-user-to-group",
        "title_zh": "将用户添加至用户组",
        "overview_zh": "如果当前用户邮箱后缀为 authing.cn，将其加入 ROOT_GROUP_ID 对应的用户组。 ROOT_GROUP_ID 从全局环境变量 env 中获取，有关如何使用环境变量，请见：https://docs.authing.cn/authing/extensibility/pipeline/env . 这里使用了 Authing Node SDK 的权限控制 API, 在这里可以了解更多：https://docs.authing.cn/authing/sdk/sdk-for-node/rbac",
        "categories": [
          "访问控制"
        ],
        "types": [
          "POST_AUTHENTICATION"
        ],
        "code": "async function pipe(user, context, callback) {\n  if (!user.email.endsWith('@authing.cn')) {\n    return callback(null, user, context)\n  }\n\n  try {\n    await authing.authz.addUserToGroup({\n      userId: user._id,\n      groupId: env.ROOT_GROUP_ID\n    })\n  } catch (error) { }\n\n  callback(null, user, context)\n}"
      },
      {
        "id": "email-domain-whitelist",
        "title_zh": "注册邮箱后缀白名单",
        "overview_zh": "若当前请求属于邮箱注册，只允许后缀为 example.com 的邮箱注册，否则返回 Access denied 错误提示。",
        "categories": [
          "访问控制"
        ],
        "types": [
          "PRE_REGISTER"
        ],
        "code": "async function pipe(context, callback) {\n  const email = context.data.userInfo.email;\n  // 非邮箱注册方式\n  if (!email) {\n    return callback(null, context)\n  }\n  if (!email.endsWith(\"example.com\")) {\n    return callback(new Error('Access denied.'));\n  }\n  return callback(null, context);\n}"
      },
      {
        "id": "ip-range-whitelist",
        "title_zh": "注册 IP 段白名单",
        "overview_zh": "只允许在特定 IP 段的用户可以注册。 这里使用 utils.ipRangeCheck() 方法判断 IP 是否在 IP 段 110.53.254.1 ～ 110.53.254.255 之间。 有关内置 utils 模块的使用，请见 https://docs.authing.cn//authing/extensibility/pipeline/available-node-modules .",
        "categories": [
          "访问控制"
        ],
        "types": [
          "PRE_REGISTER"
        ],
        "code": "async function pipe(context, callback) {\n  const utils = require(\"./utils\")\n  const ip = context.ip\n  if (ip && utils.ipRangeCheck(ip, [\"110.53.254.1\", \"110.53.254.255\"])) {\n    return callback(null, context)\n  }\n  return callback(new Error('Access Denied!'))\n}"
      },
      {
        "id": "phone-whitelist",
        "title_zh": "注册手机号白名单",
        "overview_zh": "只有在白名单列表内的手机号才能注册，这里手机号列表用 \",\" 逗号隔开。 PHONE_WHITELIST 从全局环境变量 env 中获取，有关如何使用环境变量，请见：https://docs.authing.cn//authing/extensibility/pipeline/env .",
        "categories": [
          "访问控制"
        ],
        "types": [
          "PRE_REGISTER"
        ],
        "code": "async function pipe(context, callback) {\n  // 非手机号注册跳过\n  const phone = context.data.userInfo.phone\n  if (!phone) {\n    return callback(null, context)\n  }\n\n  const whitelist = env.PHONE_WHITELIST.split(',')\n  if (whitelist.indexOf(phone) === -1) {\n    return callback(new Error('Access Denied!'))\n  }\n  return callback(null, context)\n}"
      }
    ]
  },
  {
    "name": "WebHook",
    "templates": [
      {
        "id": "dingtalk-notify",
        "title_zh": "钉钉群通知",
        "overview_zh": "当有新用户注册时，通过钉钉群机器人通知。 DINGTALK_WEBHOOK 从全局环境变量 env 中获取，有关如何使用环境变量，请见：https://docs.authing.cn/authing/extensibility/pipeline/env . 有关钉钉群机器人使用方法请见：https://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq/d535db33 .",
        "categories": [
          "WebHook"
        ],
        "types": [
          "POST_REGISTER",
          "POST_AUTHENTICATION"
        ],
        "code": "async function pipe(user, context, callback) {\n  const webhook = env.DINGTALK_WEBHOOK\n  await axios.post(webhook, {\n    \"msgtype\": \"text\",\n    \"text\": {\n      \"content\": `Authing 新用户注册 ～\nID: ${user._id}\n昵称：${user.username}\n注册方式：${user.registerMethod}\n邮箱：${user.email}\n手机号：${user.phone}\nUA: ${user.device}\n用户池 ID: ${user.registerInClient}`\n    },\n  })\n  callback(null, user, context)\n}"
      },
      {
        "id": "lark-notify",
        "title_zh": "飞书新注册通知",
        "overview_zh": "当有新用户注册时，通过飞书群机器人通知。 LARK_WEBHOOK 从全局环境变量 env 中获取，有关如何使用环境变量，请见：https://docs.authing.cn/authing/extensibility/pipeline/env .",
        "categories": [
          "WebHook"
        ],
        "types": [
          "POST_REGISTER",
          "POST_AUTHENTICATION"
        ],
        "code": "async function pipe(user, context, callback) {\n  const webhook = env.LARK_WEBHOOK\n  await axios.post(webhook, {\n    title: \"Authing 新用户注册 ~\",\n    text: `用户信息：\nID: ${user._id}\n昵称：${user.username}\n注册方式：${user.registerMethod}\n邮箱：${user.email}\n手机号：${user.phone}\nUA: ${user.device}\n用户池 ID: ${user.registerInClient}\n`\n  })\n  return callback(null, user, context)\n}"
      },
      {
        "id": "slack-notify",
        "title_zh": "Slack 群通知",
        "overview_zh": "新用户注册 Slack 群通知。 SLACK_WEBHOOK 从全局环境变量 env 中获取，有关如何使用环境变量，请见：https://docs.authing.cn//authing/extensibility/pipeline/env . 有关 Slack Incoming Message 使用方法请见：https://www.slack.com/services/new/incoming-webhook .",
        "categories": [
          "WebHook"
        ],
        "types": [
          "POST_REGISTER",
          "POST_AUTHENTICATION"
        ],
        "code": "async function pipe(user, context, callback) {\n  const qs = require('querystring')\n  const webhook = env.SLACK_WEBHOOK\n  const body = qs.stringify({\n    payload: JSON.stringify({\n      text: `Authing 新用户注册 ～\nID: ${user._id}\n昵称：${user.username}\n注册方式：${user.registerMethod}\n邮箱：${user.email}\n手机号：${user.phone}\nUA: ${user.device}\n用户池 ID: ${user.registerInClient}`\n    })\n  })\n  await axios.post(webhook, body, {\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded'\n    }\n  })\n  callback(null, user, context)\n}"
      }
    ]
  }
]